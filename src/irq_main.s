			.rtmodel cpu, "*"
			
			.extern modplay_play
			.extern keyboard_update
			.extern keyboard_test
			.extern fontsys_clearscreen
			.extern program_update
			.extern _Zp

			.extern channel_tempvolume;

zp_cadr		.equlab	_Zp + 40

samp1		.byte 0
samp2		.byte 0
samp3		.byte 0
samp4		.byte 0

; ------------------------------------------------------------------------------------

			.public irq_main
irq_main:
			php
			pha
			phx
			phy
			phz

			lda #0x0f
			sta 0xd020
			sta 0xd021

			jsr modplay_play
			jsr fontsys_clearscreen
			jsr program_update
			jsr keyboard_update

			lda #0x32 + 12*8 + 1
			sta 0xd012
			lda #.byte0 irq_main2
			sta 0xfffe
			lda #.byte1 irq_main2
			sta 0xffff

			plz
			ply
			plx
			pla
			plp
			asl 0xd019
			rti

; ------------------------------------------------------------------------------------

irq_main2:
			php
			pha
			phx
			phy
			phz

			lda 0xd012
waitr1$:	cmp 0xd012
			beq waitr1$

			clc
			lda 0xd012
			adc #0x08

			ldx #0xe2
			stx 0xd20f
			stx 0xd21f
			ldx #0xf4
			stx 0xd30f
			stx 0xd31f

waitr2$:	cmp 0xd012
			bne waitr2$

			ldx #0x00
			stx 0xd20f
			stx 0xd21f
			stx 0xd30f
			stx 0xd31f


			ldx #39

			ldz #0x00
			lda #0x00
			sta zp_cadr+3
			sta 0xd770
			sta 0xd771
			sta 0xd772
			sta 0xd773
			sta 0xd774
			sta 0xd775
			sta 0xd776
			sta 0xd777

loopsamplerend$:

			; get current sample strengths, convert to unsigned and store in samp1234
			lda 0xd72a
			sta zp_cadr+0
			lda 0xd72b
			sta zp_cadr+1
			lda 0xd72c
			sta zp_cadr+2
			lda [zp:zp_cadr],z
			bpl ge1$
			eor 0xff
ge1$:		sta samp1

			lda 0xd73a
			sta zp_cadr+0
			lda 0xd73b
			sta zp_cadr+1
			lda 0xd73c
			sta zp_cadr+2
			lda [zp:zp_cadr],z
			bpl ge2$
			eor 0xff
ge2$:		sta samp2

			lda 0xd74a
			sta zp_cadr+0
			lda 0xd74b
			sta zp_cadr+1
			lda 0xd74c
			sta zp_cadr+2
			lda [zp:zp_cadr],z
			bpl ge3$
			eor 0xff
ge3$:		sta samp3

			lda 0xd75a
			sta zp_cadr+0
			lda 0xd75b
			sta zp_cadr+1
			lda 0xd75c
			sta zp_cadr+2
			lda [zp:zp_cadr],z
			bpl ge4$
			eor 0xff
ge4$:		sta samp4

			; multiply samples with current channel volumes
			lda channel_tempvolume+0
			sta 0xd770
			lda samp1
			sta 0xd774
			lda 0xd779
			sta samp1

			lda channel_tempvolume+1
			sta 0xd770
			lda samp2
			sta 0xd774
			lda 0xd779
			sta samp2

			lda channel_tempvolume+2
			sta 0xd770
			lda samp3
			sta 0xd774
			lda 0xd779
			sta samp3

			lda channel_tempvolume+3
			sta 0xd770
			lda samp4
			sta 0xd774
			lda 0xd779
			sta samp4

/*
			; get highest volume for all samples (0-63)
			lda samp1
			cmp samp2
			bcs	ge10$
			lda samp2
ge10$:		cmp samp3
			bcs ge11$
			lda samp3
ge11$:		cmp samp4
			bcs ge12$
			lda samp4
ge12$:
*/

			lda samp1

			; multiply by 4 to get back to 0-255 range
			asl a
			asl a

			; multiply with visual falloff
			sta 0xd770
			stx 0xd774
			lda 0xd779

			; multiply again to get in roughly 0-160 range
			asl a
			asl a
			asl a	; too much?

			; swap nybbles and show as border colour
			jsr swapnybbles
			sta 0xd10f



			lda samp2

			; multiply by 4 to get back to 0-255 range
			asl a
			asl a

			; multiply with visual falloff
			sta 0xd770
			stx 0xd774
			lda 0xd779

			; multiply again to get in roughly 0-160 range
			asl a
			asl a
			asl a	; too much?

			; swap nybbles and show as border colour
			jsr swapnybbles
			sta 0xd20f



			lda samp3

			; multiply by 4 to get back to 0-255 range
			asl a
			asl a

			; multiply with visual falloff
			sta 0xd770
			stx 0xd774
			lda 0xd779

			; multiply again to get in roughly 0-160 range
			asl a
			asl a
			asl a	; too much?

			; swap nybbles and show as border colour
			jsr swapnybbles
			sta 0xd30f






			lda 0xd012
waitr4$:	cmp 0xd012
			beq waitr4$

			dex
			bmi loopsamplerendend$
			jmp loopsamplerend$

loopsamplerendend$:

			lda #0x00
			sta 0xd10f
			sta 0xd20f
			sta 0xd30f

			lda #0xff
			sta 0xd012
			lda #.byte0 irq_main
			sta 0xfffe
			lda #.byte1 irq_main
			sta 0xffff

			plz
			ply
			plx
			pla
			plp
			asl 0xd019
			rti

; ------------------------------------------------------------------------------------

swapnybbles:

			asl a						; swap nybbles
			adc #0x80
			rol a
			asl a
			adc #0x80
			rol a
			rts

; ------------------------------------------------------------------------------------

			; these are just shifted so can be combined!

spectrumpalred:
			.byte 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
			.byte 0xff, 0xef, 0xdf, 0xcf, 0xbf, 0xaf, 0x9f, 0x8f, 0x7f, 0x6f, 0x5f, 0x4f, 0x3f, 0x2f, 0x1f, 0x00
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
			.byte 0x00, 0x1f, 0x2f, 0x3f, 0x4f, 0x5f, 0x6f, 0x7f, 0x8f, 0x9f, 0xaf, 0xbf, 0xcf, 0xdf, 0xef, 0xff
			.byte 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff

spectrumpalgreen:
			.byte 0x00, 0x0f, 0x1f, 0x2f, 0x3f, 0x4f, 0x5f, 0x6f, 0x7f, 0x8f, 0x9f, 0xaf, 0xbf, 0xcf, 0xdf, 0xef
			.byte 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
			.byte 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
			.byte 0xff, 0xef, 0xdf, 0xcf, 0xbf, 0xaf, 0x9f, 0x8f, 0x7f, 0x6f, 0x5f, 0x4f, 0x3f, 0x2f, 0x1f, 0x00
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00

spectrumpalblue:
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
			.byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
			.byte 0x00, 0x0f, 0x1f, 0x2f, 0x3f, 0x4f, 0x5f, 0x6f, 0x7f, 0x8f, 0x9f, 0xaf, 0xbf, 0xcf, 0xdf, 0xef
			.byte 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
			.byte 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
			.byte 0xff, 0xef, 0xdf, 0xcf, 0xbf, 0xaf, 0x9f, 0x8f, 0x7f, 0x6f, 0x5f, 0x4f, 0x3f, 0x2f, 0x1f, 0x00
